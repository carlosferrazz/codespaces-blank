<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Teste Supabase</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body style="background:#111;color:white;font-family:Arial;padding:20px;">

<h2>Teste de Login e Contador</h2>

<button onclick="login()">LOGIN AUTOMÁTICO</button>
<button onclick="check()">VER STATUS</button>
<button onclick="usar()">USAR 1 VEZ</button>

<p id="status">Status: ---</p>
<p id="contador">Uso: ---</p>

<script>

const supabaseClient = window.supabase.createClient(
  "https://fgatcdryezszrojoledj.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZnYXRjZHJ5ZXpzenJvam9sZWRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNTA2NTEsImV4cCI6MjA4NjcyNjY1MX0.kv9k1EkVYGYUpUcpdGMIF_n3uGFlAxa37nCjx-ZsDaM"
);

function hoje(){
  return new Date().toISOString().split("T")[0];
}

async function login(){
  const { error } = await supabaseClient.auth.signInWithPassword({
    email: "carlosmoreira12.cm@gmail.com",
    password: "Bruno331452@"
  });

  if(error){
    alert("Erro login: " + error.message);
  } else {
    alert("Logado!");
    check();
  }
}

async function check(){
  const { data: { user } } = await supabaseClient.auth.getUser();

  if(user){
    document.getElementById("status").innerText =
      "Logado como: " + user.email;
  } else {
    document.getElementById("status").innerText =
      "NÃO LOGADO ❌";
  }
}

async function usar(){

  const { data: { user } } = await supabaseClient.auth.getUser();
  if(!user){
    alert("Faça login primeiro");
    return;
  }

  const { data } = await supabaseClient
    .from("usage_control")
    .select("*")
    .eq("user_id", user.id);

  let registro = data && data.length > 0 ? data[0] : null;

  if(!registro){

    await supabaseClient.from("usage_control").insert({
      user_id: user.id,
      start_date: hoje(),
      last_use_date: hoje(),
      daily_count: 1
    });

    document.getElementById("contador").innerText =
      "Uso criado = 1";

    return;
  }

  let novo = registro.daily_count + 1;

  await supabaseClient
    .from("usage_control")
    .update({ daily_count: novo })
    .eq("user_id", user.id);

  document.getElementById("contador").innerText =
    "Uso atualizado = " + novo;
}

</script>

</body>
</html>
