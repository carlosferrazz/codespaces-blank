<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>NeuroProfit AI - Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  font-family: Arial;
  background: #0f172a;
  color: white;
  padding: 20px;
}

.card {
  background: #1e293b;
  padding: 20px;
  border-radius: 10px;
  margin-bottom: 20px;
}

input {
  padding: 10px;
  width: 100%;
  margin-bottom: 10px;
  border-radius: 6px;
  border: none;
}

button {
  padding: 10px 15px;
  background: #06b6d4;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
}

button:hover {
  opacity: 0.8;
}
</style>

</head>
<body>

<h2>Gerador de Roteiros</h2>
<p>Status: <strong id="loginStatus">Verificando...</strong></p>
<button onclick="logout()">Sair</button>
<hr>
<div class="card">
  <input id="prompt" placeholder="Digite o tema do roteiro">
  <button onclick="generateScript()">Gerar Roteiro</button>

  <p id="status"></p>
  <p>Restantes hoje: <span id="remaining">2</span></p>
  <p>Dias restantes: <span id="daysLeft">3</span></p>
</div>

<script>

const supabaseClient = window.supabase.createClient(
  "https://fgatcdryezszrojoledj.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZnYXRjZHJ5ZXpzenJvam9sZWRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNTA2NTEsImV4cCI6MjA4NjcyNjY1MX0.kv9k1EkVYGYUpUcpdGMIF_n3uGFlAxa37nCjx-ZsDaM"
);

const MAX_DAYS = 3;
const MAX_PER_DAY = 2;

function getToday(){
  return new Date().toISOString().split("T")[0];
}

function daysBetween(date1, date2){
  return Math.floor(
    (new Date(date2) - new Date(date1)) / (1000*60*60*24)
  );
}

async function loadStatus(){

  const { data: { user } } = await supabaseClient.auth.getUser();
  if(!user) return;

  const today = getToday();

  const { data } = await supabaseClient
    .from("usage_control")
    .select("*")
    .eq("user_id", user.id)
    .single();

  if(!data){
    document.getElementById("remaining").innerText = MAX_PER_DAY;
    document.getElementById("daysLeft").innerText = MAX_DAYS;
    return;
  }

  const totalDays = daysBetween(data.start_date, today);
  const daysLeft = MAX_DAYS - totalDays;

  let dailyCount = data.daily_count || 0;

  if(today !== data.last_use_date){
    dailyCount = 0;
  }

  document.getElementById("remaining").innerText =
    MAX_PER_DAY - dailyCount;

  document.getElementById("daysLeft").innerText =
    daysLeft > 0 ? daysLeft : 0;
}

async function generateScript(){

  const { data: { user } } = await supabaseClient.auth.getUser();

  if(!user){
    alert("Faça login primeiro.");
    return;
  }

  const today = getToday();

  const { data, error } = await supabaseClient
    .from("usage_control")
    .select("*")
    .eq("user_id", user.id)
    .single();

  if(error && error.code !== "PGRST116"){
    alert("Erro ao buscar dados");
    console.log(error);
    return;
  }

  if(!data){

    const { error: insertError } = await supabaseClient
      .from("usage_control")
      .insert({
        user_id: user.id,
        start_date: today,
        last_use_date: today,
        daily_count: 1
      });

    if(insertError){
      alert("Erro ao criar registro");
      console.log(insertError);
      return;
    }

    alert("Primeiro uso registrado!");
    loadStatus();
    return;
  }

  const totalDays = daysBetween(data.start_date, today);

  if(totalDays >= MAX_DAYS){
    alert("Plano gratuito expirou.");
    return;
  }

  let dailyCount = data.daily_count || 0;

  if(today !== data.last_use_date){
    dailyCount = 0;
  }

  if(dailyCount >= MAX_PER_DAY){
    alert("Limite diário atingido.");
    return;
  }

  const newCount = dailyCount + 1;

  const { error: updateError } = await supabaseClient
    .from("usage_control")
    .update({
      daily_count: newCount,
      last_use_date: today
    })
    .eq("user_id", user.id);

  if(updateError){
    alert("Erro ao atualizar");
    console.log(updateError);
    return;
  }

  alert("Uso atualizado!");
  loadStatus();
}

loadStatus();

</script>

</body>
</html>
