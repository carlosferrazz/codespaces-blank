<script>

const supabaseClient = window.supabase.createClient(
  "https://fgatcdryezszrojoledj.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZnYXRjZHJ5ZXpzenJvam9sZWRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNTA2NTEsImV4cCI6MjA4NjcyNjY1MX0.kv9k1EkVYGYUpUcpdGMIF_n3uGFlAxa37nCjx-ZsDaM"
);

let currentUser = null;
let userProfile = null;
let userUsage = null;

/* =========================
   AUTENTICAÃ‡ÃƒO
========================= */

async function authAction(){

  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  const { data, error } = await supabaseClient.auth.signInWithPassword({
    email,
    password
  });

  if(error){
    alert(error.message);
    return;
  }

  startApp();
}

/* =========================
   INICIAR APP
========================= */

async function startApp(){

  document.getElementById("authScreen").classList.add("hidden");
  document.getElementById("app").classList.remove("hidden");

  const { data:{user} } = await supabaseClient.auth.getUser();
  currentUser = user;

  // PERFIL
  const { data:profile } = await supabaseClient
    .from("perfis")
    .select("*")
    .eq("id", user.id)
    .single();

  userProfile = profile;

  // CONTROLE DE USO
  const { data:usage } = await supabaseClient
    .from("controle_de_uso")
    .select("*")
    .eq("user_id", user.id)
    .single();

  userUsage = usage;

  loadDashboard();
}

/* =========================
   DASHBOARD
========================= */

function loadDashboard(){

  document.getElementById("planoUsuario").innerText = userProfile.plano;
  document.getElementById("hojeCount").innerText = userUsage.daily_count;
  document.getElementById("totalCount").innerText = userUsage.total_generated;

}

/* =========================
   VERIFICAR LIMITE
========================= */

async function checkLimit(){

  if(userProfile.plano === "pro") return true;

  const today = new Date().toISOString().split("T")[0];

  if(userUsage.last_use_date !== today){

    await supabaseClient
      .from("controle_de_uso")
      .update({
        daily_count: 0,
        last_use_date: today
      })
      .eq("user_id", currentUser.id);

    userUsage.daily_count = 0;
  }

  if(userUsage.daily_count >= 3){
    alert("Limite diÃ¡rio atingido!");
    return false;
  }

  return true;
}

/* =========================
   GERAR ROTEIRO
========================= */

async function generateScript(){

  const allowed = await checkLimit();
  if(!allowed) return;

  const roteiroGerado = "Roteiro exemplo gerado com IA ðŸš€";

  await supabaseClient
    .from("controle_de_uso")
    .update({
      daily_count: userUsage.daily_count + 1,
      total_generated: userUsage.total_generated + 1,
      last_use_date: new Date().toISOString().split("T")[0]
    })
    .eq("user_id", currentUser.id);

  await supabaseClient
    .from("histÃ³rico_de_scripts")
    .insert([{
      user_id: currentUser.id,
      titulo: "Roteiro Teste",
      conteudo: roteiroGerado
    }]);

  userUsage.daily_count++;
  userUsage.total_generated++;

  loadDashboard();

  alert("Roteiro gerado com sucesso!");
}

/* =========================
   LOGOUT
========================= */

async function logout(){
  await supabaseClient.auth.signOut();
  location.reload();
}

</script>
